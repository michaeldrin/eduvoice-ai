{% extends "base.html" %}

{% block title %}Document Questions - {{ document.filename }}{% endblock %}

{% block head %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css" rel="stylesheet">
<style>
  .question-card {
    margin-bottom: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s;
  }
  
  .question-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  
  .card-header {
    font-weight: 600;
    padding: 1rem;
    border-radius: 8px 8px 0 0;
  }
  
  .extracted-question {
    border-left: 4px solid #5b86e5;
  }
  
  .generated-question {
    border-left: 4px solid #36b37e;
  }
  
  .question-text {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
  }
  
  .answer-text {
    font-size: 1rem;
    line-height: 1.6;
  }
  
  .loading-spinner {
    display: none;
    text-align: center;
    padding: 20px;
  }
  
  #notes-editor {
    height: 300px;
    margin-bottom: 1rem;
  }
  
  .ql-editor {
    min-height: 250px;
  }
  
  .editor-toolbar {
    margin-bottom: 0.5rem;
  }
  
  .save-status {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
    margin-left: 0.5rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
  <!-- Navigation and document info -->
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('document_preview', document_id=document.id) }}">{{ document.filename }}</a></li>
      <li class="breadcrumb-item active" aria-current="page">Questions</li>
    </ol>
  </nav>
  
  <div class="row mb-4">
    <div class="col-md-8">
      <h1 class="mb-3">Document Questions</h1>
      <h5 class="text-muted">{{ document.filename }}</h5>
      
      <!-- Language info -->
      <div class="d-flex align-items-center mb-3">
        <span class="badge rounded-pill bg-primary me-2">
          {% if document.translated_language and document.translated_content %}
            Translated to: {{ document.translated_language }}
          {% else %}
            Original: {{ document.language }}
          {% endif %}
        </span>
        
        <!-- Process questions button (if not processed) -->
        {% if not document.questions_processed %}
          <form method="POST" action="{{ url_for('process_document_questions_route', document_id=document.id) }}" class="ms-2">
            <button type="submit" class="btn btn-sm btn-primary">
              <i class="bi bi-lightning-charge"></i> Process Questions
            </button>
          </form>
        {% endif %}
      </div>
    </div>
    
    <div class="col-md-4 text-md-end">
      <div class="btn-group" role="group">
        <a href="{{ url_for('document_preview', document_id=document.id) }}" class="btn btn-outline-secondary">
          <i class="bi bi-file-text"></i> Preview
        </a>
        <a href="{{ url_for('document_chat', document_id=document.id) }}" class="btn btn-outline-primary">
          <i class="bi bi-chat-dots"></i> Chat
        </a>
      </div>
    </div>
  </div>
  
  <!-- Tabs for Questions and Notes -->
  <ul class="nav nav-tabs mb-4" id="documentTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="questions-tab" data-bs-toggle="tab" data-bs-target="#questions-content" type="button" role="tab" aria-controls="questions-content" aria-selected="true">
        <i class="bi bi-question-circle"></i> Questions
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes-content" type="button" role="tab" aria-controls="notes-content" aria-selected="false">
        <i class="bi bi-journal-text"></i> Notes
      </button>
    </li>
  </ul>
  
  <div class="tab-content" id="documentTabsContent">
    <!-- Questions Tab -->
    <div class="tab-pane fade show active" id="questions-content" role="tabpanel" aria-labelledby="questions-tab">
      <div id="loading-questions" class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Processing document questions...</p>
      </div>
      
      <!-- Questions Container -->
      <div id="questions-container">
        {% if questions and questions|length > 0 %}
          <div class="mb-3">
            <span class="badge bg-secondary">{{ questions|length }} questions</span>
            
            {% set extracted_count = questions|selectattr('is_extracted', 'eq', true)|list|length %}
            {% if extracted_count > 0 %}
              <span class="badge bg-info ms-2">{{ extracted_count }} extracted</span>
            {% endif %}
            
            {% set generated_count = questions|selectattr('is_extracted', 'eq', false)|list|length %}
            {% if generated_count > 0 %}
              <span class="badge bg-success ms-2">{{ generated_count }} generated</span>
            {% endif %}
          </div>
          
          <!-- List of questions -->
          {% for question in questions %}
            <div class="card question-card {% if question.is_extracted %}extracted-question{% else %}generated-question{% endif %}">
              <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                  <i class="bi {% if question.is_extracted %}bi-bookmark-star{% else %}bi-robot{% endif %} me-2"></i>
                  {% if question.is_extracted %}
                    Extracted Question
                  {% else %}
                    Generated Question
                  {% endif %}
                </div>
                <span class="badge bg-secondary">{{ question.language }}</span>
              </div>
              <div class="card-body">
                <p class="question-text">{{ question.question_text }}</p>
                <hr>
                <div class="answer-text">
                  {{ question.answer_text|safe }}
                </div>
              </div>
            </div>
          {% endfor %}
        {% elif document.questions_processed %}
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            No questions were found or generated for this document. Try changing the language or processing the document again.
          </div>
        {% else %}
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            This document has not been processed for questions yet. Click the "Process Questions" button to extract or generate questions from the document content.
          </div>
        {% endif %}
      </div>
    </div>
    
    <!-- Notes Tab -->
    <div class="tab-pane fade" id="notes-content" role="tabpanel" aria-labelledby="notes-tab">
      <div class="card">
        <div class="card-header bg-light">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Document Notes</h5>
            <div>
              <div class="input-group">
                <input type="text" id="note-title" class="form-control" placeholder="Note Title" value="Notes for {{ document.filename }}">
                <span id="save-status" class="save-status text-success"></span>
              </div>
            </div>
          </div>
          <div class="editor-toolbar mt-2">
            <select id="note-language" class="form-select form-select-sm d-inline-block w-auto">
              <option value="en" {% if user_settings.language == 'en' %}selected{% endif %}>English</option>
              <option value="es" {% if user_settings.language == 'es' %}selected{% endif %}>Spanish</option>
              <option value="fr" {% if user_settings.language == 'fr' %}selected{% endif %}>French</option>
              <option value="de" {% if user_settings.language == 'de' %}selected{% endif %}>German</option>
              <option value="it" {% if user_settings.language == 'it' %}selected{% endif %}>Italian</option>
              <option value="pt" {% if user_settings.language == 'pt' %}selected{% endif %}>Portuguese</option>
              <option value="ru" {% if user_settings.language == 'ru' %}selected{% endif %}>Russian</option>
              <option value="zh" {% if user_settings.language == 'zh' %}selected{% endif %}>Chinese</option>
              <option value="ja" {% if user_settings.language == 'ja' %}selected{% endif %}>Japanese</option>
              <option value="ko" {% if user_settings.language == 'ko' %}selected{% endif %}>Korean</option>
              <option value="ar" {% if user_settings.language == 'ar' %}selected{% endif %}>Arabic</option>
            </select>
          </div>
        </div>
        <div class="card-body">
          <div id="notes-editor"></div>
          
          <div class="mt-3 d-flex justify-content-between">
            <button id="save-note" class="btn btn-primary">
              <i class="bi bi-save"></i> Save Notes
            </button>
            <div class="btn-group">
              <button id="export-html" class="btn btn-outline-secondary">
                <i class="bi bi-file-earmark-code"></i> Export HTML
              </button>
              <button id="export-text" class="btn btn-outline-secondary">
                <i class="bi bi-file-earmark-text"></i> Export Text
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascript %}
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize Quill editor
    const quill = new Quill('#notes-editor', {
      theme: 'snow',
      modules: {
        toolbar: [
          [{ 'font': [] }, { 'size': [] }],
          ['bold', 'italic', 'underline', 'strike'],
          [{ 'color': [] }, { 'background': [] }],
          [{ 'script': 'super' }, { 'script': 'sub' }],
          [{ 'header': 1 }, { 'header': 2 }, 'blockquote', 'code-block'],
          [{ 'list': 'ordered' }, { 'list': 'bullet' }, { 'indent': '-1' }, { 'indent': '+1' }],
          [{ 'direction': 'rtl' }, { 'align': [] }],
          ['link', 'image', 'video'],
          ['clean']
        ]
      },
      placeholder: 'Write your notes here...'
    });
    
    // Variables
    const documentId = {{ document.id }};
    const saveNoteBtn = document.getElementById('save-note');
    const exportHtmlBtn = document.getElementById('export-html');
    const exportTextBtn = document.getElementById('export-text');
    const noteTitleInput = document.getElementById('note-title');
    const noteLanguageSelect = document.getElementById('note-language');
    const saveStatus = document.getElementById('save-status');
    
    let saveTimeout;
    let currentNoteId = null;
    
    // Load existing note if available
    loadNote();
    
    // Save note function
    function saveNote() {
      const content = quill.root.innerHTML;
      const title = noteTitleInput.value.trim() || `Notes for ${documentId}`;
      const language = noteLanguageSelect.value;
      
      if (!content || content === '<p><br></p>') {
        showSaveStatus('Nothing to save', 'text-warning');
        return;
      }
      
      showSaveStatus('Saving...', 'text-info');
      
      const noteData = {
        document_id: documentId,
        title: title,
        content: content,
        language: language,
        note_id: currentNoteId
      };
      
      fetch('/api/document/save_note', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(noteData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          currentNoteId = data.note_id;
          showSaveStatus('Saved!', 'text-success');
        } else {
          showSaveStatus('Error: ' + data.error, 'text-danger');
        }
      })
      .catch(error => {
        console.error('Error saving note:', error);
        showSaveStatus('Failed to save', 'text-danger');
      });
    }
    
    // Load note function
    function loadNote() {
      fetch(`/api/document/${documentId}/notes`)
        .then(response => response.json())
        .then(data => {
          if (data.success && data.notes && data.notes.length > 0) {
            // Get the most recent note
            const note = data.notes[0];
            quill.root.innerHTML = note.content;
            noteTitleInput.value = note.title;
            currentNoteId = note.id;
            
            // Set language if available
            if (note.language) {
              noteLanguageSelect.value = note.language;
            }
          }
        })
        .catch(error => {
          console.error('Error loading notes:', error);
        });
    }
    
    // Auto-save on content change
    quill.on('text-change', function() {
      clearTimeout(saveTimeout);
      showSaveStatus('Unsaved changes', 'text-warning');
      
      saveTimeout = setTimeout(() => {
        saveNote();
      }, 3000); // Auto-save after 3 seconds of inactivity
    });
    
    // Manual save button
    saveNoteBtn.addEventListener('click', function() {
      clearTimeout(saveTimeout);
      saveNote();
    });
    
    // Export buttons
    exportHtmlBtn.addEventListener('click', function() {
      const content = quill.root.innerHTML;
      const title = noteTitleInput.value.trim() || `Notes for ${documentId}`;
      downloadFile(title + '.html', content, 'text/html');
    });
    
    exportTextBtn.addEventListener('click', function() {
      const content = quill.root.textContent;
      const title = noteTitleInput.value.trim() || `Notes for ${documentId}`;
      downloadFile(title + '.txt', content, 'text/plain');
    });
    
    // Helper functions
    function showSaveStatus(message, className) {
      saveStatus.textContent = message;
      saveStatus.className = 'save-status ' + className;
      
      // Clear after 3 seconds
      setTimeout(() => {
        if (className === 'text-success') {
          saveStatus.textContent = '';
        }
      }, 3000);
    }
    
    function downloadFile(filename, content, contentType) {
      const blob = new Blob([content], { type: contentType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  });
</script>
{% endblock %}